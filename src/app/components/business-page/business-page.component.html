<div class="page">
    <div class="container">
      <!-- Error -->
      <div class="alert alert-error" *ngIf="serverError">
        {{ serverError }}
      </div>

      <!-- Skeleton -->
      <div class="skeleton" *ngIf="isLoading">
        <div class="skeleton-header"></div>
        <div class="skeleton-kpis">
          <div class="skeleton-card" *ngFor="let i of [1,2,3,4]"></div>
        </div>
        <div class="skeleton-row"></div>
      </div>

      <!-- Contenido -->
      <ng-container *ngIf="!isLoading && currentBusiness?.length">
        <div class="header">
          <div class="brand">
            <img
              *ngIf="currentBusiness[0]?.logo"
              [src]="currentBusiness[0].logo | bufferToBase64: currentBusiness[0].logoMimeType"
              alt="Logo del negocio"
            />
            <div class="info">
              <h1 class="name">{{ currentBusiness[0]?.name || 'Negocio' }}</h1>
              <div class="meta">
                <span class="chip">{{ currentBusiness[0]?.email || 'sin-email' }}</span>
                <span class="chip chip-id">ID: {{ currentBid }}</span>
                <span class="status active" i18n="@@activoDesgns">Activo</span>
              </div>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" (click)="onOpenAdjust()" i18n="@@loadPoints">Cargar puntos</button>
            <button class="btn" (click)="onIssuePass()" i18n="@@issuePass">Emitir pase</button>
            <!--<button class="btn ghost" (click)="adminDesings(currentBusiness[0]?.id)" i18n="@@manageDesings">Administrar Dise√±os</button>-->
            <button class="btn danger" (click)="logout()">Log out</button>
          </div>
        </div>

        <!-- KPIs -->
        <section class="kpis">
          <div class="card kpi">
            <div class="kpi-label" i18n="@@activePasses">Pases activos</div>
            <div class="kpi-value">‚Äî</div>
            <div class="kpi-hint" i18n="@@last7days">√öltimos 7 d√≠as</div>
          </div>

          <div class="card kpi">
            <div class="kpi-label"i18n="@@addedToday">A√±adidos hoy</div>
            <div class="kpi-value">‚Äî</div>
            <div class="kpi-hint"i18n="@@today">hoy</div>
          </div>

          <div class="card kpi">
            <div class="kpi-label" i18n="@@redeptionToday">Redenciones hoy</div>
            <div class="kpi-value">‚Äî</div>
            <div class="kpi-hint" i18n="@@today">Hoy</div>
          </div>

          <div class="card kpi">
            <div class="kpi-label" i18n="@@passivePoints">Pasivo en puntos</div>
            <div class="kpi-value">‚Äî</div>
            <div class="kpi-hint" i18n="@@estimated">estimado</div>
          </div>
        </section>

        <!-- Detalle negocio -->
        <section class="grid">
          <div class="card">
            <h3 i18n="@@businessDetails">Detalles del negocio</h3>
            <div class="dl">
              <div class="dt" i18n="@@name">Nombre</div>
              <div class="dd">{{ currentBusiness[0]?.name }}</div>

              <div class="dt" i18n="@@email">Email</div>
              <div class="dd">{{ currentBusiness[0]?.email || '‚Äî' }}</div>

              <div class="dt" i18n="@@createdAt">Creado</div>
              <div class="dd">{{ currentBusiness[0]?.created_atFormat }}</div>

              <div class="dt" i18n="@@updatedAt">Actualizado</div>
              <div class="dd">{{ currentBusiness[0]?.updated_atFormat }}</div>
            </div>
          </div>

          <div class="card">
            <h3 i18n="@@walletProgram">Programa Wallet</h3>
            <div class="dl">
              <div class="dt" >Pass Type ID</div>
              <div class="dd">{{ currentBusiness[0]?.pass_type_id || '‚Äî' }}</div>

              <div class="dt">BG Color</div>
              <div class="dd">{{ currentBusiness[0]?.background_color || '‚Äî' }}</div>

              <div class="dt">Terms</div>
              <div class="dd terms">{{ currentBusiness[0]?.terms || '‚Äî' }}</div>
            </div>
          </div>
        </section>
      </ng-container>

      <!-- Empty state -->
    <div class="empty" *ngIf="!isLoading && !currentBusiness?.length && !serverError">
      <p i18n="@@">No se encontr√≥ informaci√≥n del negocio.</p>
    </div>

    <!-- Tabla de usuarios (solo desktop, sin mobile cards) -->
    <section class="card table-card" *ngIf="!isLoading">
      <div class="table-header">
        <h3 i18n="@@users">Usuarios</h3>
        <span class="sub">{{ userRows.length }} usuarios registrados</span>
      </div>

      <div class="table-wrapper">
        <table class="table users">
          <thead>
            <tr>
              <th class="col-name">Nombre</th>
              <th class="col-email">Correo</th>
              <th class="col-type">Tipo</th>
              <th class="col-value">Valor</th>
              <th class="col-date">Creado</th>
              <th class="col-actions">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let u of userRows; trackBy: trackById">
              <!-- Nombre con ID -->
              <td class="col-name">
                <div class="user-name">{{ u.name }}</div>
                <div class="user-id">#{{ u.id }}</div>
              </td>

              <!-- Email -->
              <td class="col-email">{{ u.email }}</td>

              <!-- Tipo con badge -->
              <td class="col-type">
                <span
                  class="badge"
                  [class.badge-points]="u.cardType === 'points'"
                  [class.badge-strips]="u.cardType === 'strips'"
                  [class.badge-none]="!u.cardType"
                >
                  {{ u.cardType === 'points' ? '‚≠ê Puntos' : u.cardType === 'strips' ? 'üé´ Strips' : '‚Äî' }}
                </span>
              </td>

              <!-- Valor actual -->
              <td class="col-value">
                <span class="value-display">
                  <strong>{{ u.currentValue }}</strong>
                  <span *ngIf="u.cardType === 'strips' && u.maxStrips" class="max-value">
                    / {{ u.maxStrips }}
                  </span>
                </span>
              </td>

              <!-- Fecha -->
              <td class="col-date">{{ u.created_atFormat }}</td>

              <!-- Acciones -->
              <td class="col-actions">
                <div class="actions-group">
                  <!-- Agregar -->
                  <button
                    class="btn small primary"
                    (click)="openAddPointsStripsById(u.id)"
                    [disabled]="!u.cardType"
                    title="Agregar puntos o strips"
                  >
                    <i class="icon">‚ûï</i>
                    <span class="btn-text">Agregar</span>
                  </button>

                  <!-- Eliminar -->
                  <button
                    class="btn small danger"
                    (click)="onDeleteUser(u)"
                    title="Eliminar usuario"
                  >
                    <i class="icon">üóëÔ∏è</i>
                    <span class="btn-text">Eliminar</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Empty state -->
      <div class="empty" *ngIf="!userRows.length">
        <p>No hay usuarios registrados todav√≠a</p>
      </div>
</section>

    <!-- Modal Ajuste de Puntos (mantener por compatibilidad con sistema anterior) -->
    <div class="backdrop" *ngIf="adjust.open" (click)="!adjust.busy && onCloseAdjust()"></div>

    <div class="modal" *ngIf="adjust.open" role="dialog" aria-modal="true">
      <div class="modal-panel" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3 i18n="@@updatePoints">Ajustar puntos</h3>
          <button class="btn close" (click)="onCloseAdjust()" [disabled]="adjust.busy">‚úï</button>
        </div>

        <div class="modal-body">
          <div class="who">
            <div class="name">{{ adjust.name }}</div>
            <div class="muted">{{ adjust.email }}</div>
          </div>

          <div class="row">
            <label i18n="@@current">Actual</label>
            <div class="value">{{ adjust.currentPoints }}</div>
          </div>

          <div class="row">
            <label>Delta</label>
            <div class="delta">
              <button class="btn chip" (click)="bump(-50)" [disabled]="adjust.busy">-50</button>
              <button class="btn chip" (click)="bump(-10)" [disabled]="adjust.busy">-10</button>
              <input class="input num" type="number" [(ngModel)]="adjust.delta" [disabled]="adjust.busy">
              <button class="btn chip" (click)="bump(10)"  [disabled]="adjust.busy">+10</button>
              <button class="btn chip" (click)="bump(50)"  [disabled]="adjust.busy">+50</button>
            </div>
          </div>

          <div class="preview" i18n="@@Nuevo">
            Nuevo: <b>{{ (adjust.currentPoints || 0) + (+adjust.delta || 0) }}</b>
          </div>

          <div class="alert alert-error" *ngIf="adjust.error">{{ adjust.error }}</div>
        </div>

        <div class="modal-actions">
          <button class="btn ghost" (click)="onCloseAdjust()" [disabled]="adjust.busy" i18n="@@cancel">Cancelar</button>
          <button class="btn primary" (click)="applyAdjust()" [disabled]="!canApply()" i18n="@@apply">Aplicar</button>
        </div>
      </div>
    </div>
  </div>
</div>
