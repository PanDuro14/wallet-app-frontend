<!-- admin-scan-component HTML-->
<div class="login-card">
  <div class="scan-card">
    <h2 i18n="@@scan-title">Escanear tarjeta del cliente</h2>

    <!-- SECCIÃ“N DE BÃšSQUEDA -->
    <div class="search-section">
      <label for="searchQuery" i18n="@@search-client">Buscar cliente</label>
      <div class="search-input-group">
        <input
          id="searchQuery"
          class="input"
          [(ngModel)]="searchQuery"
          placeholder="Serial, email o telÃ©fono"
          i18n-placeholder="@@searchPlaceholder"
          (keyup.enter)="searchUsers()"
          [disabled]="busy"
        />
      </div>

      <button
        class="btn btn-search"
        [disabled]="busy || !searchQuery.trim()"
        (click)="searchUsers()"
        i18n="@@button-search"
      >
        <span *ngIf="busy">ğŸ” Buscando...</span>
        <span *ngIf="!busy">Buscar</span>
      </button>

      <p class="hint" i18n="@@hint">
        Puedes buscar por UUID, correo electrÃ³nico o nÃºmero de telÃ©fono
      </p>

      <div *ngIf="busy && !showResults" class="search-loading">
        <div class="spinner"></div>
        <p>Buscando en el negocio...</p>
      </div>

      <div *ngIf="searchAttempted && !busy && searchResults.length === 0 && !userData" class="search-empty">
        <div class="empty-icon">ğŸ”</div>
        <p class="empty-title">No se encontraron usuarios</p>
        <p class="empty-hint">
          Verifica que el tÃ©rmino de bÃºsqueda sea correcto y que el usuario pertenezca a este negocio.
        </p>
      </div>
    </div>

    <!-- RESULTADOS DE BÃšSQUEDA -->
    <div *ngIf="showResults && searchResults.length > 0" class="search-results">
      <div class="results-header">
        <h3 i18n="@@select-user">Selecciona un usuario:</h3>
        <span class="results-count">{{ searchResults.length }} resultado(s)</span>
      </div>
      <div class="results-list">
        <div
          *ngFor="let user of searchResults"
          class="result-item"
          (click)="selectUser(user)"
        >
          <div class="result-info">
            <strong>{{ user.name }}</strong>
            <span class="result-detail" *ngIf="user.email">ğŸ“§ {{ user.email }}</span>
            <span class="result-detail" *ngIf="user.phone">ğŸ“± {{ user.phone }}</span>
            <span class="result-serial">ğŸ« Serial: {{ user.serial }}</span>
          </div>
          <div class="result-type">
            {{ user.card_type === 'strips' ? 'ğŸ« ColecciÃ³n' : 'â­ Puntos' }}
          </div>
        </div>
      </div>
    </div>

    <div class="divider">O</div>

    <!-- ESCANEO CON CÃMARA -->
    <ng-container *ngIf="cameraReady; else noCam">
      <div class="video-wrap" [class.expanded]="scanning" [class.compact]="!scanning">
        <video
          #video
          playsinline
          webkit-playsinline
          muted
          autoplay
          style="width:100%;height:auto;object-fit:cover;background:#000"
        ></video>
      </div>

       <button
        class="btn"
        (click)="toggleScan(); $event.stopPropagation()"
        i18n="@@start-camera"
      >
        {{ scanning ? 'Detener cÃ¡mara' : 'Iniciar cÃ¡mara' }}
      </button>
    </ng-container>

    <ng-template #noCam>
      <p i18n="@@camera-unsupported">
        Tu navegador no soporta cÃ¡mara o no tiene permisos.
      </p>
    </ng-template>

    <!-- Callback de escaneo exitoso -->
    <div *ngIf="scannedSuccessfully" class="scan-success" i18n="@@scan-success">
      âœ… Â¡Escaneo exitoso!
    </div>

    <!-- INFORMACIÃ“N DEL USUARIO SELECCIONADO -->
    <div *ngIf="userData && userData.name" class="user-info-card">
      <h3 i18n="@@selected-client">Cliente seleccionado</h3>
      <div class="user-details">
        <p><strong i18n="@@phName">Nombre:</strong> {{ userData.name }}</p>
        <p *ngIf="userData.email"><strong i18n="@@phEmail">Email:</strong> {{ userData.email }}</p>
        <p *ngIf="userData.phone"><strong i18n="@@phPhone">TelÃ©fono:</strong> {{ userData.phone }}</p>
        <p class="serial-display"><strong>Serial:</strong> <code>{{ code }}</code></p>

        <!-- Tarjeta de PUNTOS -->
        <ng-container *ngIf="!userData.isStrips">
          <div class="card-type-badge points" i18n="@@card-points">â­ Tarjeta de Puntos</div>
          <p class="points-display">
            <strong i18n="@@current-points">Puntos actuales:</strong>
            <span class="current">{{ currentPoints }}</span>
          </p>
          <p class="points-preview">
            <strong i18n="@@preview-points">Puntos despuÃ©s:</strong>
            <span class="preview">{{ newPoints }}</span>
          </p>
        </ng-container>

        <!-- Tarjeta de STRIPS -->
        <ng-container *ngIf="userData.isStrips">
          <div class="card-type-badge strips" i18n="@@card-strips">ğŸ« Tarjeta de ColecciÃ³n</div>

          <p class="strips-progress">
            <strong i18n="@@progress">Progreso:</strong>
            <span class="progress-bar">
              <span
                class="progress-fill"
                [style.width.%]="(userData.strips_collected / userData.strips_required) * 100"
              ></span>
            </span>
            {{ userData.strips_collected }}/{{ userData.strips_required }}
          </p>

          <p *ngIf="userData.reward_title" class="reward-title">
            <strong i18n="@@reward-title">Premio:</strong> {{ userData.reward_title }}
          </p>

          <!-- Si la colecciÃ³n estÃ¡ completada -->
          <div *ngIf="userData.reward_unlocked" class="completed-section">
            <p class="completed-badge" i18n="@@reward-unlocked">
              ğŸ‰ Â¡ColecciÃ³n completada!
            </p>
            <p class="completion-message" i18n="@@completion-instructions">
              Haz clic en el botÃ³n de abajo para gestionar el premio.
            </p>
          </div>

          <!-- Si aÃºn estÃ¡ en progreso -->
          <p *ngIf="!userData.reward_unlocked" class="next-strip">
            <strong i18n="@@next-strip">Siguiente strip a otorgar:</strong>
            <span class="strip-number">#{{ nextStripNumber }}</span>
          </p>
        </ng-container>
      </div>
    </div>

    <!-- INPUT PARA PUNTOS (solo si NO es strips) -->
    <div class="points" *ngIf="userData && !userData.isStrips">
      <label for="delta" i18n="@@points-input-label">
        Puntos a aplicar (positivo suma / negativo resta)
      </label>
      <input
        id="delta"
        class="input"
        type="number"
        name="delta"
        [(ngModel)]="delta"
        placeholder="Ej: 50 o -20"
        (ngModelChange)="updateNewPoints()"
      />
    </div>

    <!-- BOTÃ“N DE ACCIÃ“N -->
    <button
      class="btn primary"
      [disabled]="busy || !canSubmit()"
      (click)="apply()"
      *ngIf="userData"
      i18n="@@apply"
    >
      <ng-container *ngIf="userData.isStrips">
        <ng-container *ngIf="userData.reward_unlocked">
          {{ busy ? 'Procesando...' : 'Gestionar Premio' }}
        </ng-container>
        <ng-container *ngIf="!userData.reward_unlocked">
          {{ busy ? 'Aplicandoâ€¦' : 'Otorgar Strip #' + nextStripNumber }}
        </ng-container>
      </ng-container>
      <ng-container *ngIf="!userData.isStrips">
        {{ busy ? 'Aplicandoâ€¦' : 'Aplicar Puntos' }}
      </ng-container>
    </button>

    <!-- âœ… MENSAJES DE Ã‰XITO/ERROR MEJORADOS -->
    <div *ngIf="okMsg" class="alert alert-success" aria-live="polite">
      <span class="alert-icon">âœ…</span>
      <span class="alert-text" i18n="@@okMsg">OperaciÃ³n completada correctamente</span>
    </div>

    <div *ngIf="errMsg" class="alert alert-error" aria-live="assertive">
      <span class="alert-icon">âŒ</span>
      <span class="alert-text" i18n="@@errMsg">OcurriÃ³ un error al procesar la solicitud</span>
    </div>
  </div>
</div>

<!-- MODAL DE CONFIRMACIÃ“N -->
<div class="modal-overlay" *ngIf="showResetModal" (click)="confirmResetAction('cancel')">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-icon">ğŸ</div>

    <h3 i18n="@@reset-modal-title">Â¡ColecciÃ³n Completada!</h3>

    <p class="modal-message" i18n="@@reset-modal-text">
      El cliente ha completado su colecciÃ³n y desbloqueÃ³:
      <strong>{{ userData.reward_title }}</strong>
    </p>

    <p class="modal-question" i18n="@@reset-question">
      Â¿QuÃ© deseas hacer?
    </p>

    <div class="modal-actions">
      <button
        class="btn btn-redeem"
        [disabled]="busy"
        (click)="confirmResetAction('redeem')"
        i18n="@@redeem-and-reset"
      >
        <span class="btn-icon">âœ…</span>
        <span class="btn-text">
          {{ busy && resetAction === 'redeem' ? 'Procesando...' : 'Canjear y Reiniciar' }}
        </span>
      </button>

      <button
        class="btn btn-reset-only"
        [disabled]="busy"
        (click)="confirmResetAction('reset')"
        i18n="@@reset-only"
      >
        <span class="btn-icon">ğŸ”„</span>
        <span class="btn-text">
          {{ busy && resetAction === 'reset' ? 'Reiniciando...' : 'Solo Reiniciar' }}
        </span>
      </button>

      <button
        class="btn btn-cancel"
        [disabled]="busy"
        (click)="confirmResetAction('cancel')"
        i18n="@@cancel"
      >
        Cancelar
      </button>
    </div>

    <p class="modal-hint" i18n="@@modal-hint">
      <strong>Canjear y Reiniciar:</strong> Marca el premio como entregado y reinicia la colecciÃ³n.<br>
      <strong>Solo Reiniciar:</strong> Reinicia sin marcar como canjeado (Ãºtil para pruebas).
    </p>
  </div>
</div>
