<div class="login-card">
  <div class="scan-card">
    <h2 i18n="@@scan-title">Escanear tarjeta del cliente</h2>

    <!-- SECCI√ìN DE B√öSQUEDA -->
    <div class="search-section">
      <label for="searchQuery" i18n="@@search-client">Buscar cliente</label>
      <div class="search-input-group">
        <input
          id="searchQuery"
          class="input"
          [(ngModel)]="searchQuery"
          placeholder="Serial, email o tel√©fono"
          (keyup.enter)="searchUsers()"
        />
      </div>

      <button class="btn btn-search" [disabled]="busy" (click)="searchUsers()" i18n="@@button-search">
        {{ busy ? 'Buscando...' : 'Buscar' }}
      </button>

      <p class="hint" i18n="@@hint">
        Puedes buscar por UUID, correo electr√≥nico o n√∫mero de tel√©fono
      </p>
    </div>

    <!-- RESULTADOS DE B√öSQUEDA -->
    <div *ngIf="showResults && searchResults.length > 0" class="search-results">
      <h3 i18n="@@select-user">Selecciona un usuario:</h3>
      <div class="results-list">
        <div
          *ngFor="let user of searchResults"
          class="result-item"
          (click)="selectUser(user)"
        >
          <div class="result-info">
            <strong>{{ user.name }}</strong>
            <span class="result-detail" *ngIf="user.email"> {{ user.email }}</span>
            <span class="result-detail" *ngIf="user.phone"> {{ user.phone }}</span>
            <span class="result-serial">Serial: {{ user.serial }}</span>
          </div>
          <div class="result-type">
            {{ user.card_type === 'strips' ? 'üé´ Colecci√≥n' : '‚≠ê Puntos' }}
          </div>
        </div>
      </div>
    </div>

    <div class="divider">O</div>

    <!-- ESCANEO CON C√ÅMARA -->
    <ng-container *ngIf="cameraReady; else noCam">
      <div class="video-wrap" [class.expanded]="scanning" [class.compact]="!scanning">
        <video
          #video
          playsinline
          webkit-playsinline
          muted
          autoplay
          style="width:100%;height:auto;object-fit:cover;background:#000"
        ></video>
      </div>

      <button class="btn" (click)="toggleScan()" i18n="@@start-camera">
        {{ scanning ? 'Detener c√°mara' : 'Iniciar c√°mara' }}
      </button>
    </ng-container>

    <ng-template #noCam>
      <p i18n="@@camera-unsupported">
        Tu navegador no soporta c√°mara o no tiene permisos.
      </p>
    </ng-template>

    <!-- Callback de escaneo exitoso -->
    <div *ngIf="scannedSuccessfully" class="scan-success" i18n="@@scan-success">
      ¬°Escaneo exitoso! :D
    </div>

    <!-- INFORMACI√ìN DEL USUARIO SELECCIONADO -->
    <div *ngIf="userData && userData.name" class="user-info-card">
      <h3 i18n="@@selected-client">Cliente seleccionado</h3>
      <div class="user-details">
        <p><strong i18n="@@phName">Nombre:</strong> {{ userData.name }}</p>
        <p *ngIf="userData.email"><strong i18n="@@phEmail">Email:</strong> {{ userData.email }}</p>
        <p *ngIf="userData.phone"><strong i18n="@@phPhone">Tel√©fono:</strong> {{ userData.phone }}</p>
        <p class="serial-display"><strong>Serial:</strong> <code>{{ code }}</code></p>

        <!-- Tarjeta de PUNTOS -->
        <ng-container *ngIf="!userData.isStrips">
          <div class="card-type-badge points" i18n="@@card-points">Tarjeta de Puntos</div>
          <p class="points-display">
            <strong i18n="@@current-points">Puntos actuales:</strong>
            <span class="current">{{ currentPoints }}</span>
          </p>
          <p class="points-preview">
            <strong i18n="@@preview-points">Puntos despu√©s:</strong>
            <span class="preview">{{ newPoints }}</span>
          </p>
        </ng-container>

        <!-- Tarjeta de STRIPS -->
        <ng-container *ngIf="userData.isStrips">
          <div class="card-type-badge strips" i18n="@@card-strips">Tarjeta de Colecci√≥n</div>

          <p class="strips-progress">
            <strong i18n="@@progress">Progreso:</strong>
            <span class="progress-bar">
              <span
                class="progress-fill"
                [style.width.%]="(userData.strips_collected / userData.strips_required) * 100"
              ></span>
            </span>
            {{ userData.strips_collected }}/{{ userData.strips_required }}
          </p>

          <p *ngIf="userData.reward_title" class="reward-title">
            <strong i18n="@@reward-title">Premio:</strong> {{ userData.reward_title }}
          </p>

          <!-- Si la colecci√≥n est√° completada -->
          <div *ngIf="userData.reward_unlocked" class="completed-section">
            <p class="completed-badge" i18n="@@reward-unlocked">
              üéâ ¬°Colecci√≥n completada!
            </p>
            <p class="completion-message" i18n="@@completion-instructions">
              Haz clic en el bot√≥n de abajo para gestionar el premio.
            </p>
          </div>

          <!-- Si a√∫n est√° en progreso -->
          <p *ngIf="!userData.reward_unlocked" class="next-strip">
            <strong i18n="@@next-strip">Siguiente strip a otorgar:</strong>
            <span class="strip-number">#{{ nextStripNumber }}</span>
          </p>
        </ng-container>
      </div>
    </div>

    <!-- INPUT PARA PUNTOS (solo si NO es strips) -->
    <div class="points" *ngIf="userData && !userData.isStrips">
      <label for="delta" i18n="@@points-input-label">
        Puntos a aplicar (positivo suma / negativo resta)
      </label>
      <input
        id="delta"
        class="input"
        type="number"
        name="delta"
        [(ngModel)]="delta"
        placeholder="Ej: 50 o -20"
        (ngModelChange)="updateNewPoints()"
      />
    </div>

    <!-- BOT√ìN DE ACCI√ìN -->
    <button
      class="btn primary"
      [disabled]="busy || !canSubmit()"
      (click)="apply()"
      *ngIf="userData"
      i18n="@@apply"
    >
      <ng-container *ngIf="userData.isStrips">
        <ng-container *ngIf="userData.reward_unlocked">
          {{ busy ? 'Procesando...' : 'Gestionar Premio' }}
        </ng-container>
        <ng-container *ngIf="!userData.reward_unlocked">
          {{ busy ? 'Aplicando‚Ä¶' : 'Otorgar Strip #' + nextStripNumber }}
        </ng-container>
      </ng-container>
      <ng-container *ngIf="!userData.isStrips">
        {{ busy ? 'Aplicando‚Ä¶' : 'Aplicar Puntos' }}
      </ng-container>
    </button>

    <p class="ok" *ngIf="okMsg" aria-live="polite" i18n="@@okMsg">
      Operaci√≥n completada correctamente
    </p>
    <p class="err" *ngIf="errMsg" aria-live="assertive" i18n="@@errMsg">
      Ocurri√≥ un error al procesar la solicitud
    </p>
  </div>
</div>

<!-- MODAL DE CONFIRMACI√ìN -->
<div class="modal-overlay" *ngIf="showResetModal" (click)="confirmResetAction('cancel')">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-icon">üéÅ</div>

    <h3 i18n="@@reset-modal-title">¬°Colecci√≥n Completada!</h3>

    <p class="modal-message" i18n="@@reset-modal-text">
      El cliente ha completado su colecci√≥n y desbloque√≥:
      <strong>{{ userData.reward_title }}</strong>
    </p>

    <p class="modal-question" i18n="@@reset-question">
      ¬øQu√© deseas hacer?
    </p>

    <div class="modal-actions">
      <button
        class="btn btn-redeem"
        [disabled]="busy"
        (click)="confirmResetAction('redeem')"
        i18n="@@redeem-and-reset"
      >
        <span class="btn-icon">‚úÖ</span>
        <span class="btn-text">
          {{ busy && resetAction === 'redeem' ? 'Procesando...' : 'Canjear y Reiniciar' }}
        </span>
      </button>

      <button
        class="btn btn-reset-only"
        [disabled]="busy"
        (click)="confirmResetAction('reset')"
        i18n="@@reset-only"
      >
        <span class="btn-icon">üîÑ</span>
        <span class="btn-text">
          {{ busy && resetAction === 'reset' ? 'Reiniciando...' : 'Solo Reiniciar' }}
        </span>
      </button>

      <button
        class="btn btn-cancel"
        [disabled]="busy"
        (click)="confirmResetAction('cancel')"
        i18n="@@cancel"
      >
        Cancelar
      </button>
    </div>

    <p class="modal-hint" i18n="@@modal-hint">
      <strong>Canjear y Reiniciar:</strong> Marca el premio como entregado y reinicia la colecci√≥n.<br>
      <strong>Solo Reiniciar:</strong> Reinicia sin marcar como canjeado (√∫til para pruebas).
    </p>
  </div>
</div>
