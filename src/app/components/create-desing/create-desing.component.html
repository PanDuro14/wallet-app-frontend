<!-- create-desing.component.html -->

<div class="viewport-wrap">
<div class="login-card">
  <!-- Header -->
  <div class="login-header">
    <h1 class="login-title">Crear dise√±o</h1>
    <p class="login-sub">Configura y guarda tu <code>design_json</code></p>
  </div>

  <div class="divider"></div>

  <!-- Form -->
  <form class="user-form" [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>

    <!-- Selector de Tipo de Tarjeta -->
    <label>Tipo de Tarjeta</label>
    <select class="input" formControlName="cardType">
      <option value="points">Puntos (Points)</option>
      <option value="strips">Tiras (Strips)</option>
    </select>

    <div class="divider"></div>

    <!-- Business / Program -->
    <input class="input"
           type="text"
           formControlName="programName"
           placeholder="Program name (ej. Windoe)"
           [disabled]="form.get('hideProgramName')?.value">
    <div class="hint error" *ngIf="fc('programName').invalid && fc('programName').touched">
      Programa es requerido.
    </div>

    <div class="divider"></div>

    <!-- Colores -->
    <label>Background</label>
    <div class="password-row">
      <input class="input"
             type="text"
             formControlName="background"
             placeholder="#074f63"
             (blur)="fixHex('background')">
      <input class="input" type="color"
             [value]="colorForPicker('background')"
             (input)="syncFromPicker('background', $event)">
      <button type="button" class="eye-btn" title="Gotero"
              (click)="pickWithEyedropper('background')"></button>
    </div>
    <div class="hint error" *ngIf="fc('background').invalid && fc('background').touched">
      Usa hex v√°lido (#RGB/#RRGGBB con o sin alfa).
    </div>

    <label>Foreground</label>
    <div class="password-row">
      <input class="input"
             type="text"
             formControlName="foreground"
             placeholder="#E6E6E6"
             (blur)="fixHex('foreground')">
      <input class="input" type="color"
             [value]="colorForPicker('foreground')"
             (input)="syncFromPicker('foreground', $event)">
      <button type="button" class="eye-btn" title="Gotero"
              (click)="pickWithEyedropper('foreground')"></button>
    </div>
    <div class="hint error" *ngIf="fc('foreground').invalid && fc('foreground').touched">
      Usa hex v√°lido.
    </div>

    <label>Label (opcional)</label>
    <div class="password-row">
      <input class="input"
             type="text"
             formControlName="label"
             placeholder="#FFFFFF"
             (blur)="fixHex('label', true)">
      <input class="input" type="color"
             [value]="colorForPicker('label')"
             (input)="syncFromPicker('label', $event)">
      <button type="button" class="eye-btn" title="Gotero"
              (click)="pickWithEyedropper('label')"></button>
    </div>

    <div class="divider"></div>

    <!-- Flags -->
    <label>
      <input type="checkbox" formControlName="disableStrip"> Ocultar strip
    </label>
    <label>
      <input type="checkbox" formControlName="disableLogo"> Ocultar logo superior
    </label>
    <label>
      <input type="checkbox" formControlName="hideAccount"> Ocultar "cuenta"
    </label>
    <label>
      <input type="checkbox" formControlName="hideProgramName"> Ocultar "nombre"
    </label>

    <div class="divider"></div>

    <!-- ‚úÖ NUEVO: Configuraci√≥n espec√≠fica de STRIPS -->
    <div *ngIf="isStripsMode">

      <!-- ‚úÖ SELECTOR DE MODO: Single vs Multi-Tier -->
      <label>Tipo de Recompensas</label>
      <div style="display: flex; gap: 16px; margin-bottom: 16px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="radio" formControlName="rewardMode" value="single">
          <span>Una sola recompensa (Single)</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="radio" formControlName="rewardMode" value="multi-tier">
          <span>M√∫ltiples niveles (Multi-Tier)</span>
        </label>
      </div>

      <div class="divider"></div>

      <!-- ‚úÖ CONFIGURACI√ìN SINGLE (original) -->
      <div *ngIf="!isMultiTierMode">
        <label>Total de Strips</label>
        <input class="input"
               type="number"
               formControlName="stripsTotal"
               min="2"
               max="20"
               placeholder="8">
        <div class="hint error" *ngIf="fc('stripsTotal').invalid && fc('stripsTotal').touched">
          Debe ser entre 2 y 20 strips.
        </div>

        <label>T√≠tulo del Premio</label>
        <input class="input"
               type="text"
               formControlName="stripsRewardTitle"
               placeholder="Ej. Caf√© Gratis">
        <div class="hint error" *ngIf="fc('stripsRewardTitle').invalid && fc('stripsRewardTitle').touched">
          El t√≠tulo del premio es requerido.
        </div>

        <label>Descripci√≥n del Premio (opcional)</label>
        <input class="input"
               type="text"
               formControlName="stripsRewardDescription"
               placeholder="Ej. Un caf√© americano gratis">
      </div>

      <!-- ‚úÖ CONFIGURACI√ìN MULTI-TIER (nueva) -->
      <div *ngIf="isMultiTierMode">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <label style="margin: 0;">Recompensas por Nivel</label>
          <button type="button"
                  class="button"
                  style="height:36px;background:#10b981;color:#fff;"
                  (click)="addReward()">
            + Agregar Nivel
          </button>
        </div>

        <div class="hint" style="color:#6b7280;margin-bottom:16px;">
          üí° Define los premios que el cliente ir√° desbloqueando conforme avanza.
          Ejemplo: Nivel 1 = Caf√©, Nivel 2 = Caf√© + Cookie, Nivel 3 = Bebida Premium.
        </div>

        <!-- Array de recompensas -->
        <div formArrayName="rewards" style="display: flex; flex-direction: column; gap: 16px;">
          <div *ngFor="let reward of rewardsFA().controls; let i = index"
               [formGroupName]="i"
               style="padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">

            <!-- Header del nivel -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <strong style="color: #111827;">Nivel {{ i + 1 }}</strong>
              <button type="button"
                      class="button"
                      style="height:32px;background:#ef4444;color:#fff;padding:0 12px;"
                      (click)="removeReward(i)"
                      [disabled]="rewardsFA().length === 1">
                √ó Eliminar
              </button>
            </div>

            <!-- Campos del reward -->
            <div style="display: grid; gap: 12px;">
              <div>
                <label style="display: block; margin-bottom: 4px; font-size: 14px;">
                  T√≠tulo del Premio *
                </label>
                <input class="input"
                       formControlName="title"
                       placeholder="Ej. Caf√© Americano Gratis"
                       style="width: 100%;">
                <div class="hint error"
                     *ngIf="reward.get('title')?.invalid && reward.get('title')?.touched">
                  El t√≠tulo es requerido.
                </div>
              </div>

              <div>
                <label style="display: block; margin-bottom: 4px; font-size: 14px;">
                  Descripci√≥n (opcional)
                </label>
                <input class="input"
                       formControlName="description"
                       placeholder="Ej. Completa {{ reward.get('strips_required')?.value }} visitas"
                       style="width: 100%;">
              </div>

              <div>
                <label style="display: block; margin-bottom: 4px; font-size: 14px;">
                  Strips Requeridos *
                </label>
                <input class="input"
                       type="number"
                       formControlName="strips_required"
                       min="1"
                       max="20"
                       placeholder="5"
                       style="width: 100%;">
                <div class="hint error"
                     *ngIf="reward.get('strips_required')?.invalid && reward.get('strips_required')?.touched">
                  Debe ser entre 1 y 20.
                </div>
              </div>
            </div>
          </div>

          <!-- Mensaje si no hay recompensas -->
          <div *ngIf="rewardsFA().length === 0"
               style="padding: 32px; text-align: center; color: #6b7280; border: 2px dashed #e5e7eb; border-radius: 8px;">
            No hay niveles configurados. Haz clic en "+ Agregar Nivel" para empezar.
          </div>
        </div>

        <!-- Resumen total -->
        <div *ngIf="rewardsFA().length > 0"
             style="margin-top: 16px; padding: 12px; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe;">
          <div style="font-size: 14px; color: #1e40af;">
            üìä <strong>Total de strips necesarios:</strong>
            {{ totalStripsRequired }} strips para completar {{ totalLevels }} nivel(es)
          </div>
        </div>
      </div>

      <!-- Layout (com√∫n para ambos modos) -->
      <div class="divider"></div>
      <label>Layout</label>
      <select class="input" formControlName="stripsLayout">
        <option value="horizontal">Horizontal</option>
        <option value="vertical">Vertical</option>
      </select>

      <div class="divider"></div>

      <!-- Primary Fields -->
      <div class="field">
        <label>Campos Primarios</label>
        <div formArrayName="primaryFields">
          <div *ngFor="let field of primaryFieldsFA().controls; let i = index"
               [formGroupName]="i"
               style="display:grid;grid-template-columns:1fr 1fr 1fr 40px;gap:8px;margin-bottom:8px;">
            <input class="input" formControlName="key" placeholder="Key">
            <input class="input" formControlName="label" placeholder="Label">
            <input class="input" formControlName="value" placeholder="Value">
            <button type="button" class="button" style="height:32px;background:#ef4444;color:#fff;padding:0;"
                    (click)="removeField('primary', i)">√ó</button>
          </div>
        </div>
        <button type="button" class="button" style="height:36px;background:#10b981;color:#fff;margin-top:8px;"
                (click)="addField('primary')">+ Agregar Campo Primario</button>
      </div>

      <!-- Secondary Fields -->
      <div class="field">
        <label>Campos Secundarios</label>
        <div formArrayName="secondaryFields">
          <div *ngFor="let field of secondaryFieldsFA().controls; let i = index"
               [formGroupName]="i"
               style="display:grid;grid-template-columns:1fr 1fr 1fr 40px;gap:8px;margin-bottom:8px;">
            <input class="input" formControlName="key" placeholder="Key">
            <input class="input" formControlName="label" placeholder="Label">
            <input class="input" formControlName="value" placeholder="Value">
            <button type="button" class="button" style="height:32px;background:#ef4444;color:#fff;padding:0;"
                    (click)="removeField('secondary', i)">√ó</button>
          </div>
        </div>
        <button type="button" class="button" style="height:36px;background:#10b981;color:#fff;margin-top:8px;"
                (click)="addField('secondary')">+ Agregar Campo Secundario</button>
      </div>

      <!-- Back Fields -->
      <div class="field">
        <label>Campos Traseros</label>
        <div formArrayName="backFields">
          <div *ngFor="let field of backFieldsFA().controls; let i = index"
               [formGroupName]="i"
               style="display:grid;grid-template-columns:1fr 1fr 1fr 40px;gap:8px;margin-bottom:8px;">
            <input class="input" formControlName="key" placeholder="Key">
            <input class="input" formControlName="label" placeholder="Label">
            <input class="input" formControlName="value" placeholder="Value">
            <button type="button" class="button" style="height:32px;background:#ef4444;color:#fff;padding:0;"
                    (click)="removeField('back', i)">√ó</button>
          </div>
        </div>
        <button type="button" class="button" style="height:36px;background:#10b981;color:#fff;margin-top:8px;"
                (click)="addField('back')">+ Agregar Campo Trasero</button>
      </div>

      <div class="divider"></div>
    </div>

    <!-- Barcode -->
    <label>Formato de c√≥digo de barras</label>
    <select class="input" formControlName="primary">
      <option *ngFor="let f of formats" [value]="f">{{ f }}</option>
    </select>

    <!-- Campos adicionales solo para modo POINTS -->
    <ng-container *ngIf="!isStripsMode">
      <input class="input"
             type="text"
             formControlName="message"
             placeholder="{{'{{cardCode}}'}}">

      <input class="input"
             type="text"
             formControlName="altText"
             placeholder="{{'{{cardCode}}'}}">

      <input class="input"
             type="text"
             formControlName="encoding"
             placeholder="iso-8859-1">

      <!-- Chips sencillos para additional -->
      <div>
        <span>Formatos adicionales:</span>
        <button type="button"
                class="button"
                style="height:32px;border-radius:8px;background:#eef2ff;color:#111;"
                *ngFor="let f of formats"
                (click)="toggleAdditional(f)">
          {{ f }} <span *ngIf="isAdditional(f)">‚úî</span>
        </button>
      </div>
    </ng-container>

    <div class="divider"></div>

    <div class="field">
      <label for="terms">T√©rminos</label>
      <textarea id="terms" rows="6" formControlName="terms" placeholder="Condiciones de uso..."></textarea>
      <small class="hint">
        {{ (form.get('terms')?.value?.length || 0) }} / 5000
      </small>
    </div>

    <!-- Acciones -->
    <button class="button" type="submit" [disabled]="form.invalid || busy">
      {{ busy ? 'Guardando‚Ä¶' : 'Guardar dise√±o' }}
    </button>

    <button class="button" type="button" style="background:#e5e7eb;color:#111"
            (click)="reset()">Limpiar</button>

    <!-- Mensajes -->
    <div class="hint error" *ngIf="errorMessage">{{ errorMessage }}</div>
    <div class="hint" style="color:#10b981;" *ngIf="createdId">‚úì Creado con id: {{ createdId }}</div>

    <!-- Vista previa del JSON (opcional - descomentar si quieres ver el payload) -->
    <details style="margin-top: 24px;">
      <summary style="cursor: pointer; color: #6b7280; font-size: 14px;">
        üëÅÔ∏è Ver JSON que se enviar√°
      </summary>
      <pre class="input" style="margin-top: 12px; height:auto; background:#f9fafb; overflow:auto; font-size:12px;">{{ buildPayload() | json }}</pre>
    </details>
  </form>
</div>
</div>
