<div class="viewport-wrap">
<div class="login-card">
  <!-- Header -->
  <div class="login-header">
    <h1 class="login-title">Crear diseño</h1>
    <p class="login-sub">Configura y guarda tu <code>design_json</code></p>
  </div>

  <div class="divider"></div>

  <!-- Form -->
  <form class="user-form" [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>

    <!-- Selector de Tipo de Tarjeta -->
    <label>Tipo de Tarjeta</label>
    <select class="input" formControlName="cardType">
      <option value="points">Puntos (Points)</option>
      <option value="strips">Tiras (Strips)</option>
    </select>

    <div class="divider"></div>

    <!-- Business / Program -->
    <input class="input"
           type="text"
           formControlName="programName"
           placeholder="Program name (ej. Windoe)"
           [disabled]="form.get('hideProgramName')?.value">
    <div class="hint error" *ngIf="fc('programName').invalid && fc('programName').touched">
      Programa es requerido.
    </div>

    <div class="divider"></div>

    <!-- Colores -->
    <label>Background</label>
    <div class="password-row">
      <input class="input"
             type="text"
             formControlName="background"
             placeholder="#074f63"
             (blur)="fixHex('background')">
      <input class="input" type="color"
             [value]="colorForPicker('background')"
             (input)="syncFromPicker('background', $event)">
      <button type="button" class="eye-btn" title="Gotero"
              (click)="pickWithEyedropper('background')"></button>
    </div>
    <div class="hint error" *ngIf="fc('background').invalid && fc('background').touched">
      Usa hex válido (#RGB/#RRGGBB con o sin alfa).
    </div>

    <label>Foreground</label>
    <div class="password-row">
      <input class="input"
             type="text"
             formControlName="foreground"
             placeholder="#E6E6E6"
             (blur)="fixHex('foreground')">
      <input class="input" type="color"
             [value]="colorForPicker('foreground')"
             (input)="syncFromPicker('foreground', $event)">
      <button type="button" class="eye-btn" title="Gotero"
              (click)="pickWithEyedropper('foreground')"></button>
    </div>
    <div class="hint error" *ngIf="fc('foreground').invalid && fc('foreground').touched">
      Usa hex válido.
    </div>

    <label>Label (opcional)</label>
    <div class="password-row">
      <input class="input"
             type="text"
             formControlName="label"
             placeholder="#FFFFFF"
             (blur)="fixHex('label', true)">
      <input class="input" type="color"
             [value]="colorForPicker('label')"
             (input)="syncFromPicker('label', $event)">
      <button type="button" class="eye-btn" title="Gotero"
              (click)="pickWithEyedropper('label')"></button>
    </div>

    <div class="divider"></div>

    <!-- Flags -->
    <label>
      <input type="checkbox" formControlName="disableStrip"> Ocultar strip
    </label>
    <label>
      <input type="checkbox" formControlName="disableLogo"> Ocultar logo superior
    </label>
    <label>
      <input type="checkbox" formControlName="hideAccount"> Ocultar "cuenta"
    </label>
    <label>
      <input type="checkbox" formControlName="hideProgramName"> Ocultar "nombre"
    </label>

    <div class="divider"></div>

    <!-- Configuración específica de STRIPS -->
    <div *ngIf="isStripsMode">
      <label>Total de Strips</label>
      <input class="input"
             type="number"
             formControlName="stripsTotal"
             min="2"
             max="20"
             placeholder="8">
      <div class="hint error" *ngIf="fc('stripsTotal').invalid && fc('stripsTotal').touched">
        Debe ser entre 2 y 20 strips.
      </div>

      <label>Layout</label>
      <select class="input" formControlName="stripsLayout">
        <option value="horizontal">Horizontal</option>
        <option value="vertical">Vertical</option>
      </select>

      <label>Título del Premio</label>
      <input class="input"
             type="text"
             formControlName="stripsRewardTitle"
             placeholder="Ej. Café Gratis">
      <div class="hint error" *ngIf="fc('stripsRewardTitle').invalid && fc('stripsRewardTitle').touched">
        El título del premio es requerido.
      </div>

      <div class="divider"></div>

      <!-- Primary Fields -->
      <div class="field">
        <label>Campos Primarios</label>
        <div formArrayName="primaryFields">
          <div *ngFor="let field of primaryFieldsFA().controls; let i = index"
               [formGroupName]="i"
               style="display:grid;grid-template-columns:1fr 1fr 1fr 40px;gap:8px;margin-bottom:8px;">
            <input class="input" formControlName="key" placeholder="Key">
            <input class="input" formControlName="label" placeholder="Label">
            <input class="input" formControlName="value" placeholder="Value">
            <button type="button" class="button" style="height:32px;background:#ef4444;color:#fff;padding:0;"
                    (click)="removeField('primary', i)">×</button>
          </div>
        </div>
        <button type="button" class="button" style="height:36px;background:#10b981;color:#fff;margin-top:8px;"
                (click)="addField('primary')">+ Agregar Campo Primario</button>
      </div>

      <!-- Secondary Fields -->
      <div class="field">
        <label>Campos Secundarios</label>
        <div formArrayName="secondaryFields">
          <div *ngFor="let field of secondaryFieldsFA().controls; let i = index"
               [formGroupName]="i"
               style="display:grid;grid-template-columns:1fr 1fr 1fr 40px;gap:8px;margin-bottom:8px;">
            <input class="input" formControlName="key" placeholder="Key">
            <input class="input" formControlName="label" placeholder="Label">
            <input class="input" formControlName="value" placeholder="Value">
            <button type="button" class="button" style="height:32px;background:#ef4444;color:#fff;padding:0;"
                    (click)="removeField('secondary', i)">×</button>
          </div>
        </div>
        <button type="button" class="button" style="height:36px;background:#10b981;color:#fff;margin-top:8px;"
                (click)="addField('secondary')">+ Agregar Campo Secundario</button>
      </div>

      <!-- Back Fields -->
      <div class="field">
        <label>Campos Traseros</label>
        <div formArrayName="backFields">
          <div *ngFor="let field of backFieldsFA().controls; let i = index"
               [formGroupName]="i"
               style="display:grid;grid-template-columns:1fr 1fr 1fr 40px;gap:8px;margin-bottom:8px;">
            <input class="input" formControlName="key" placeholder="Key">
            <input class="input" formControlName="label" placeholder="Label">
            <input class="input" formControlName="value" placeholder="Value">
            <button type="button" class="button" style="height:32px;background:#ef4444;color:#fff;padding:0;"
                    (click)="removeField('back', i)">×</button>
          </div>
        </div>
        <button type="button" class="button" style="height:36px;background:#10b981;color:#fff;margin-top:8px;"
                (click)="addField('back')">+ Agregar Campo Trasero</button>
      </div>

      <div class="divider"></div>
    </div>

    <!-- Barcode -->
    <label>Formato de código de barras</label>
    <select class="input" formControlName="primary">
      <option *ngFor="let f of formats" [value]="f">{{ f }}</option>
    </select>

    <!-- Campos adicionales solo para modo POINTS -->
    <ng-container *ngIf="!isStripsMode">
      <input class="input"
             type="text"
             formControlName="message"
             placeholder="{{'{{cardCode}}'}}">

      <input class="input"
             type="text"
             formControlName="altText"
             placeholder="{{'{{cardCode}}'}}">

      <input class="input"
             type="text"
             formControlName="encoding"
             placeholder="iso-8859-1">

      <!-- Chips sencillos para additional -->
      <div>
        <span>Formatos adicionales:</span>
        <button type="button"
                class="button"
                style="height:32px;border-radius:8px;background:#eef2ff;color:#111;"
                *ngFor="let f of formats"
                (click)="toggleAdditional(f)">
          {{ f }} <span *ngIf="isAdditional(f)">✔</span>
        </button>
      </div>
    </ng-container>

    <div class="divider"></div>

    <div class="field">
      <label for="terms">Términos</label>
      <textarea id="terms" rows="6" formControlName="terms" placeholder="Condiciones de uso..."></textarea>
      <small class="hint">
        {{ (form.get('terms')?.value?.length || 0) }} / 5000
      </small>
    </div>

    <!-- Acciones -->
    <button class="button" type="submit" [disabled]="form.invalid || busy">
      {{ busy ? 'Guardando…' : 'Guardar diseño' }}
    </button>

    <button class="button" type="button" style="background:#e5e7eb;color:#111"
            (click)="reset()">Limpiar</button>

    <!-- Mensajes -->
    <div class="hint error" *ngIf="errorMessage">{{ errorMessage }}</div>
    <div class="hint" style="color:#10b981;" *ngIf="createdId">✓ Creado con id: {{ createdId }}</div>

    <!-- Vista previa del JSON (opcional - descomentar si quieres ver el payload)
    <pre class="input" style="height:auto; background:#fff; overflow:auto;">
      {{ buildPayload() | json }}
    </pre>
    -->
  </form>
</div>
</div>
